/* set yaml_metadata and endset are used for assigning variable ( key value pairs) *//* fromyml() built-in jinja function  assigns values to variables */





/*
In general, Hubs consist of 4 columns, described below.

Primary Key (src_pk)
A primary key (or surrogate key) which is usually a hashed representation of the natural key.

Natural Key / Business Key (src_nk)
This is usually a formal identification for the record, such as a incident ID. Usually called the business key because this value has meaning in business processes such as transactions and events.

Load date (src_ldts)
A load date or load date timestamp. This identifies when the record was first loaded into the database.

Record Source (src_source)
The source for the record.

Refer to following link for additional info https://dbtvault.readthedocs.io/en/latest/tutorial/tut_hubs/
*/

-- Generated by dbtvault.-- Generated by dbtvault.

WITH row_rank_1 AS (
    SELECT DISTINCT ON (rr.vehicle_insurance_hk) rr.vehicle_insurance_hk, rr.vehicle_insurance_id, rr.etl_load_datetime, rr.source
    FROM "mydw"."mydw_stage_vault"."vehicle_insurance_stage_vw" AS rr
    WHERE rr.vehicle_insurance_hk IS NOT NULL
    ORDER BY rr.vehicle_insurance_hk, rr.etl_load_datetime
),

records_to_insert AS (
    SELECT a.vehicle_insurance_hk, a.vehicle_insurance_id, a.etl_load_datetime, a.source
    FROM row_rank_1 AS a
    LEFT JOIN "mydw"."mydw_raw_vault"."vehicle_insurance_hub" AS d
    ON a.vehicle_insurance_hk = d.vehicle_insurance_hk
    WHERE d.vehicle_insurance_hk IS NULL
)

SELECT * FROM records_to_insert